<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ¸…å›¾ç‰‡å·®å¼‚å¯¹æ¯”å·¥å…· (TIFFæ”¯æŒç‰ˆ)</title>
    <!-- å¼•å…¥ UTIF.js ç”¨äºè§£æ TIFF æ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* ä¿®å¤2ï¼šå…¨å±€ç¦æ­¢æ–‡æœ¬é€‰ä¸­ï¼Œé˜²æ­¢æ‹–åŠ¨å˜è“ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* é¡¶éƒ¨æ  */
        header {
            background-color: var(--panel-bg);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
            flex-shrink: 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            position: relative;
            background-color: #444;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .btn:hover { background-color: #555; }

        .btn input[type=file] {
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        .status { font-size: 12px; color: #aaa; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* è§†å£ */
        #viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(45deg, #252525 25%, transparent 25%), 
                linear-gradient(-45deg, #252525 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #252525 75%), 
                linear-gradient(-45deg, transparent 75%, #252525 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            cursor: crosshair;
            display: flex;
            align-items: center;
            justify-content: center;
            /* ä¿®å¤2ï¼šç¡®ä¿è§†å£åŒºåŸŸä¸å¯é€‰ä¸­ */
            user-select: none; 
        }
        
        #viewport.dragging { cursor: grabbing; }

        /* æç¤ºæ–‡å­— */
        #placeholder {
            position: absolute;
            pointer-events: none;
            color: #666;
            font-size: 1.5rem;
            z-index: 0;
        }

        /* èˆå°ï¼šæ ¸å¿ƒå®¹å™¨ */
        #stage {
            position: absolute;
            top: 0; left: 0;
            transform-origin: 0 0;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: none; 
        }

        /* å›¾å±‚ */
        .layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
        }

        .layer img {
            display: block;
            width: 100%; 
            height: 100%;
            object-fit: fill; 
            pointer-events: none;
            -webkit-user-drag: none; /* é˜²æ­¢å›¾ç‰‡è¢«æ‹–æ‹½å‡ºæµè§ˆå™¨ */
        }

        /* å³ä¾§å›¾ï¼ˆåº•å±‚ï¼‰ */
        #layer-modified { z-index: 1; background: #1e1e1e; }

        /* å·¦ä¾§å›¾ï¼ˆé¡¶å±‚ï¼Œè¢«è£å‰ªï¼‰ */
        #layer-original { 
            z-index: 2; 
            width: 50%; 
            border-right: 1px solid rgba(255,255,255,0.8);
            background: #1e1e1e;
        }

        #layer-original img {
            width: auto; 
            height: 100%;
            max-width: none; 
        }

        /* æ ‡ç­¾ */
        .label {
            position: absolute;
            top: 10px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 12px;
            border-radius: 4px;
            pointer-events: none;
        }
        .label-l { left: 10px; }
        .label-r { right: 10px; }

        /* åˆ†å‰²çº¿æ‰‹æŸ„ */
        .handle {
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            width: 0; z-index: 10; pointer-events: none;
        }
        .handle-icon {
            position: absolute;
            bottom: 30px; left: -16px;
            width: 32px; height: 32px;
            background: white;
            border-radius: 50%;
            color: #333;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            font-weight: bold;
            font-size: 14px;
        }

    </style>
</head>
<body>

<header>
    <div style="font-weight:bold;">å›¾ç‰‡å¯¹æ¯”å·¥å…· (TIFF+)</div>
    <div class="controls">
        <div class="btn">
            <span>ğŸ“ åŸå›¾ (å·¦)</span>
            <!-- ä¿®å¤1ï¼šaccept å¢åŠ  .tif, .tiff -->
            <input type="file" id="fileOrig" accept="image/*,.tif,.tiff">
        </div>
        <span id="statOrig" class="status">æœªé€‰æ‹©</span>

        <div class="btn">
            <span>ğŸ“ å¤„ç†å (å³)</span>
            <input type="file" id="fileMod" accept="image/*,.tif,.tiff">
        </div>
        <span id="statMod" class="status">æœªé€‰æ‹©</span>

        <button class="btn" onclick="resetView()">âŸ² å¤ä½</button>
    </div>
</header>

<div id="viewport">
    <div id="placeholder">è¯·ä¸Šä¼ å›¾ç‰‡ (æ”¯æŒ JPG/PNG/TIFF)...</div>
    
    <div id="stage">
        <!-- åº•å±‚ï¼šModified -->
        <div id="layer-modified" class="layer">
            <img id="imgMod" src="" alt="">
            <span class="label label-r">å¤„ç†å</span>
        </div>

        <!-- é¡¶å±‚ï¼šOriginal (è¢«è£å‰ª) -->
        <div id="layer-original" class="layer">
            <img id="imgOrig" src="" alt="">
            <span class="label label-l">åŸå›¾</span>
        </div>

        <div class="handle" id="handle">
            <div class="handle-icon">â†”</div>
        </div>
    </div>
</div>

<script>
    // çŠ¶æ€ç®¡ç†
    const state = {
        scale: 1,
        x: 0, y: 0,       // èˆå°åç§»é‡
        isDragging: false,
        dragStartX: 0, dragStartY: 0,
        width: 0, height: 0
    };

    const els = {
        viewport: document.getElementById('viewport'),
        stage: document.getElementById('stage'),
        layerOrig: document.getElementById('layer-original'),
        imgOrig: document.getElementById('imgOrig'),
        imgMod: document.getElementById('imgMod'),
        handle: document.getElementById('handle'),
        placeholder: document.getElementById('placeholder')
    };

    // 1. å›¾ç‰‡ä¸Šä¼ é€»è¾‘ (åŒ…å« TIFF æ”¯æŒå’Œé‡å¤ä¸Šä¼ ä¿®å¤)
    function setupUpload(inputId, imgEl, statId) {
        const inputEl = document.getElementById(inputId);
        const statEl = document.getElementById(statId);

        inputEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            // ä¿®å¤3ï¼šæ¸…ç©º input å€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶è§¦å‘ change äº‹ä»¶
            e.target.value = '';

            statEl.textContent = "åŠ è½½ä¸­...";
            
            const fileName = file.name.toLowerCase();
            const isTiff = fileName.endsWith('.tif') || fileName.endsWith('.tiff');

            if (isTiff) {
                // ä¿®å¤1ï¼šTIFF å¤„ç†é€»è¾‘
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const buffer = evt.target.result;
                        const ifds = UTIF.decode(buffer);
                        // é€šå¸¸å–ç¬¬ä¸€é¡µ
                        const page = ifds[0]; 
                        UTIF.decodeImage(buffer, page);
                        const rgba = UTIF.toRGBA8(page);

                        // åˆ›å»ºä¸´æ—¶ Canvas è½¬æ¢æ•°æ®
                        const canvas = document.createElement('canvas');
                        canvas.width = page.width;
                        canvas.height = page.height;
                        const ctx = canvas.getContext('2d');
                        const imgData = ctx.createImageData(page.width, page.height);
                        
                        // å°† Uint8Array å¤åˆ¶åˆ° Uint8ClampedArray
                        for (let i = 0; i < rgba.length; i++) {
                            imgData.data[i] = rgba[i];
                        }
                        
                        ctx.putImageData(imgData, 0, 0);
                        
                        // è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯»çš„ URL
                        imgEl.src = canvas.toDataURL();
                        statEl.textContent = file.name;
                    } catch (err) {
                        console.error(err);
                        statEl.textContent = "TIFF è§£æå¤±è´¥";
                        alert("TIFF æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æœªæŸåã€‚");
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // æ™®é€šå›¾ç‰‡å¤„ç†
                const reader = new FileReader();
                reader.onload = (evt) => {
                    imgEl.src = evt.target.result;
                    statEl.textContent = file.name;
                };
                reader.readAsDataURL(file);
            }
        });

        // ç»‘å®š onload äº‹ä»¶ï¼Œæ— è®ºæ˜¯ TIFF è½¬æ¢åè¿˜æ˜¯æ™®é€šå›¾ç‰‡åŠ è½½åéƒ½ä¼šè§¦å‘
        imgEl.onload = () => {
            onImageLoaded(imgEl);
        };
    }

    setupUpload('fileOrig', els.imgOrig, 'statOrig');
    setupUpload('fileMod', els.imgMod, 'statMod');

    // å›¾ç‰‡åŠ è½½å›è°ƒ
    function onImageLoaded(img) {
        els.stage.style.display = 'block';
        els.placeholder.style.display = 'none';

        // æ›´æ–°èˆå°å°ºå¯¸ï¼šä»¥å½“å‰åŠ è½½çš„è¿™å¼ å›¾ä¸ºå‡†
        if (state.width === 0 || img.naturalWidth > 0) {
            state.width = img.naturalWidth;
            state.height = img.naturalHeight;
            
            // è®¾ç½®èˆå°ç‰©ç†å°ºå¯¸
            els.stage.style.width = state.width + 'px';
            els.stage.style.height = state.height + 'px';

            // å¼ºåˆ¶å·¦ä¾§åŸå›¾çš„ img å®½åº¦ç­‰äºèˆå°å®½åº¦
            els.imgOrig.style.width = state.width + 'px';
            
            // ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œè‡ªåŠ¨å¤ä½è§†å›¾
            resetView();
        }
    }

    // 2. è§†å›¾æ§åˆ¶ (ç¼©æ”¾/å¹³ç§»)
    function updateTransform() {
        els.stage.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
    }

    window.resetView = function() {
        if (state.width === 0) return;
        
        const vw = els.viewport.clientWidth;
        const vh = els.viewport.clientHeight;

        const scale = Math.min(
            (vw - 40) / state.width,
            (vh - 40) / state.height
        );
        
        state.scale = scale > 0 ? scale : 1;
        state.x = (vw - state.width * state.scale) / 2;
        state.y = (vh - state.height * state.scale) / 2;

        updateTransform();
    };

    // 3. é¼ æ ‡äº¤äº’
    
    // æ»šè½®ç¼©æ”¾
    els.viewport.addEventListener('wheel', (e) => {
        if (state.width === 0) return;
        e.preventDefault();

        const zoomIntensity = 0.1;
        const delta = e.deltaY > 0 ? -1 : 1;
        const newScale = state.scale * (1 + delta * zoomIntensity);

        if (newScale < 0.05 || newScale > 50) return;

        const mouseX = (e.clientX - state.x) / state.scale;
        const mouseY = (e.clientY - state.y) / state.scale;

        state.scale = newScale;
        state.x = e.clientX - mouseX * state.scale;
        state.y = e.clientY - mouseY * state.scale;

        updateTransform();
    }, { passive: false });

    // é¼ æ ‡æŒ‰ä¸‹ï¼šå¼€å§‹æ‹–æ‹½
    els.viewport.addEventListener('mousedown', (e) => {
        if (state.width === 0) return;
        if (e.button === 0) { // å·¦é”®
            state.isDragging = true;
            state.dragStartX = e.clientX - state.x;
            state.dragStartY = e.clientY - state.y;
            els.viewport.classList.add('dragging');
            // ä¿®å¤2ï¼šé˜²æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚é€‰ä¸­ï¼‰
            e.preventDefault();
        }
    });

    // é¼ æ ‡æ¾å¼€
    window.addEventListener('mouseup', () => {
        state.isDragging = false;
        els.viewport.classList.remove('dragging');
    });

    // é¼ æ ‡ç§»åŠ¨
    window.addEventListener('mousemove', (e) => {
        if (state.width === 0) return;

        if (state.isDragging) {
            // --- æ‹–æ‹½æ¨¡å¼ ---
            e.preventDefault();
            state.x = e.clientX - state.dragStartX;
            state.y = e.clientY - state.dragStartY;
            updateTransform();
        } else {
            // --- å¯¹æ¯”æ¨¡å¼ (ç§»åŠ¨åˆ†å‰²çº¿) ---
            const rect = els.stage.getBoundingClientRect();
            let relativeX = e.clientX - rect.left;
            let percent = (relativeX / rect.width) * 100;
            percent = Math.max(0, Math.min(100, percent));

            els.layerOrig.style.width = percent + '%';
            els.handle.style.left = percent + '%';
        }
    });

    window.addEventListener('resize', () => {
        // å¯é€‰ï¼šresetView();
    });

</script>
</body>
</html>
