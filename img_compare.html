<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ¸…å›¾ç‰‡å·®å¼‚å¯¹æ¯”å·¥å…· (ä¿®å¤æ˜¾ç¤ºç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --text-color: #e0e0e0;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        header {
            background-color: var(--panel-bg);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
            flex-shrink: 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            position: relative;
            background-color: #444;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .btn:hover { background-color: #555; }

        .btn input[type=file] {
            position: absolute;
            left: 0; top: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        .status { font-size: 12px; color: #aaa; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* è§†å£ */
        #viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(45deg, #252525 25%, transparent 25%), 
                linear-gradient(-45deg, #252525 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #252525 75%), 
                linear-gradient(-45deg, transparent 75%, #252525 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            cursor: crosshair;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #viewport.dragging { cursor: grabbing; }

        /* æç¤ºæ–‡å­— */
        #placeholder {
            position: absolute;
            pointer-events: none;
            color: #666;
            font-size: 1.5rem;
            z-index: 0;
        }

        /* èˆå°ï¼šæ ¸å¿ƒå®¹å™¨ */
        #stage {
            position: absolute;
            top: 0; left: 0;
            transform-origin: 0 0;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: none; /* åˆå§‹éšè—ï¼ŒåŠ è½½åé€šè¿‡JSæ”¹ä¸ºblock */
        }

        /* å›¾å±‚ */
        .layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
        }

        .layer img {
            display: block;
            width: 100%; 
            height: 100%;
            object-fit: fill; /* å¼ºåˆ¶å¡«æ»¡å®¹å™¨ï¼Œç”±èˆå°å°ºå¯¸æ§åˆ¶æ¯”ä¾‹ */
            pointer-events: none;
            -webkit-user-drag: none;
        }

        /* å³ä¾§å›¾ï¼ˆåº•å±‚ï¼‰ */
        #layer-modified { z-index: 1; background: #1e1e1e; }

        /* å·¦ä¾§å›¾ï¼ˆé¡¶å±‚ï¼Œè¢«è£å‰ªï¼‰ */
        #layer-original { 
            z-index: 2; 
            width: 50%; /* åˆå§‹ä¸€åŠ */
            border-right: 1px solid rgba(255,255,255,0.8);
            background: #1e1e1e;
        }

        /* 
           å…³é”®ä¿®å¤ï¼š
           å·¦ä¾§å›¾è™½ç„¶å®¹å™¨å®½åº¦å˜å°äº†ï¼Œä½†é‡Œé¢çš„å›¾ç‰‡å¿…é¡»ä¿æŒèˆå°çš„æ€»å®½åº¦ã€‚
           è¿™æ ·æ‰èƒ½ä¿è¯ä¸¤å¼ å›¾æ˜¯é‡å çš„ï¼Œè€Œä¸æ˜¯è¢«å‹ç¼©ã€‚
        */
        #layer-original img {
            width: auto; /* å…ˆè®¾ä¸ºè‡ªåŠ¨ï¼ŒJSä¼šå¼ºåˆ¶è¦†ç›–ä¸ºèˆå°å®½åº¦ */
            height: 100%;
            max-width: none; /* é˜²æ­¢CSSæ¡†æ¶å¹²æ‰° */
        }

        /* æ ‡ç­¾ */
        .label {
            position: absolute;
            top: 10px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 12px;
            border-radius: 4px;
            pointer-events: none;
        }
        .label-l { left: 10px; }
        .label-r { right: 10px; }

        /* åˆ†å‰²çº¿æ‰‹æŸ„ */
        .handle {
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            width: 0; z-index: 10; pointer-events: none;
        }
        .handle-icon {
            position: absolute;
            bottom: 30px; left: -16px;
            width: 32px; height: 32px;
            background: white;
            border-radius: 50%;
            color: #333;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            font-weight: bold;
            font-size: 14px;
        }

    </style>
</head>
<body>

<header>
    <div style="font-weight:bold;">å›¾ç‰‡å¯¹æ¯”å·¥å…· (Fix)</div>
    <div class="controls">
        <div class="btn">
            <span>ğŸ“ åŸå›¾ (å·¦)</span>
            <input type="file" id="fileOrig" accept="image/*">
        </div>
        <span id="statOrig" class="status">æœªé€‰æ‹©</span>

        <div class="btn">
            <span>ğŸ“ å¤„ç†å (å³)</span>
            <input type="file" id="fileMod" accept="image/*">
        </div>
        <span id="statMod" class="status">æœªé€‰æ‹©</span>

        <button class="btn" onclick="resetView()">âŸ² å¤ä½</button>
    </div>
</header>

<div id="viewport">
    <div id="placeholder">è¯·ä¸Šä¼ å›¾ç‰‡...</div>
    
    <div id="stage">
        <!-- åº•å±‚ï¼šModified -->
        <div id="layer-modified" class="layer">
            <img id="imgMod" src="" alt="">
            <span class="label label-r">å¤„ç†å</span>
        </div>

        <!-- é¡¶å±‚ï¼šOriginal (è¢«è£å‰ª) -->
        <div id="layer-original" class="layer">
            <img id="imgOrig" src="" alt="">
            <span class="label label-l">åŸå›¾</span>
        </div>

        <div class="handle" id="handle">
            <div class="handle-icon">â†”</div>
        </div>
    </div>
</div>

<script>
    // çŠ¶æ€ç®¡ç†
    const state = {
        scale: 1,
        x: 0, y: 0,       // èˆå°åç§»é‡
        isDragging: false,
        dragStartX: 0, dragStartY: 0,
        width: 0, height: 0
    };

    const els = {
        viewport: document.getElementById('viewport'),
        stage: document.getElementById('stage'),
        layerOrig: document.getElementById('layer-original'),
        imgOrig: document.getElementById('imgOrig'),
        imgMod: document.getElementById('imgMod'),
        handle: document.getElementById('handle'),
        placeholder: document.getElementById('placeholder')
    };

    // 1. å›¾ç‰‡ä¸Šä¼ é€»è¾‘
    function setupUpload(inputId, imgEl, statId) {
        document.getElementById(inputId).addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById(statId).textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                imgEl.src = evt.target.result;
                // å›¾ç‰‡åŠ è½½å®Œæˆåè§¦å‘
                imgEl.onload = () => {
                    onImageLoaded(imgEl);
                };
            };
            reader.readAsDataURL(file);
        });
    }

    setupUpload('fileOrig', els.imgOrig, 'statOrig');
    setupUpload('fileMod', els.imgMod, 'statMod');

    // å›¾ç‰‡åŠ è½½å›è°ƒ
    function onImageLoaded(img) {
        // åªè¦æœ‰ä¸€å¼ å›¾åŠ è½½ï¼Œå°±æ˜¾ç¤ºèˆå°
        els.stage.style.display = 'block';
        els.placeholder.style.display = 'none';

        // æ›´æ–°èˆå°å°ºå¯¸ï¼šä»¥å½“å‰åŠ è½½çš„è¿™å¼ å›¾ä¸ºå‡†ï¼ˆå‡è®¾ä¸¤å¼ å›¾å¤§å°ä¸€è‡´ï¼‰
        // å¦‚æœä¹‹å‰æ²¡æœ‰è®¾ç½®è¿‡å°ºå¯¸ï¼Œæˆ–è€…æƒ³å¼ºåˆ¶ä»¥æœ€æ–°ä¸Šä¼ çš„å›¾ä¸ºå‡†
        if (state.width === 0 || img.naturalWidth > 0) {
            state.width = img.naturalWidth;
            state.height = img.naturalHeight;
            
            // è®¾ç½®èˆå°ç‰©ç†å°ºå¯¸
            els.stage.style.width = state.width + 'px';
            els.stage.style.height = state.height + 'px';

            // å…³é”®ï¼šå¼ºåˆ¶å·¦ä¾§åŸå›¾çš„ img å®½åº¦ç­‰äºèˆå°å®½åº¦
            // å¦åˆ™å½“ layer-original å®½åº¦ä¸º 50% æ—¶ï¼Œå›¾ç‰‡ä¹Ÿä¼šè¢«æŒ¤å‹
            els.imgOrig.style.width = state.width + 'px';
            
            // ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œè‡ªåŠ¨å¤ä½è§†å›¾
            resetView();
        }
    }

    // 2. è§†å›¾æ§åˆ¶ (ç¼©æ”¾/å¹³ç§»)
    function updateTransform() {
        els.stage.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
    }

    window.resetView = function() {
        if (state.width === 0) return;
        
        const vw = els.viewport.clientWidth;
        const vh = els.viewport.clientHeight;

        // è®¡ç®—é€‚åº”å±å¹•çš„æ¯”ä¾‹ (ç•™å‡º 40px è¾¹è·)
        const scale = Math.min(
            (vw - 40) / state.width,
            (vh - 40) / state.height
        );
        
        state.scale = scale > 0 ? scale : 1; // é˜²æ­¢é™¤ä»¥0ç­‰é”™è¯¯
        
        // å±…ä¸­
        state.x = (vw - state.width * state.scale) / 2;
        state.y = (vh - state.height * state.scale) / 2;

        updateTransform();
    };

    // 3. é¼ æ ‡äº¤äº’
    
    // æ»šè½®ç¼©æ”¾
    els.viewport.addEventListener('wheel', (e) => {
        if (state.width === 0) return;
        e.preventDefault();

        const zoomIntensity = 0.1;
        const delta = e.deltaY > 0 ? -1 : 1;
        const newScale = state.scale * (1 + delta * zoomIntensity);

        // é™åˆ¶ç¼©æ”¾èŒƒå›´
        if (newScale < 0.05 || newScale > 50) return;

        // è®¡ç®—é¼ æ ‡ç›¸å¯¹äºèˆå°å·¦ä¸Šè§’çš„åæ ‡ (æœªç¼©æ”¾å‰)
        const mouseX = (e.clientX - state.x) / state.scale;
        const mouseY = (e.clientY - state.y) / state.scale;

        // æ›´æ–°ç¼©æ”¾
        state.scale = newScale;

        // ä¿®æ­£ä½ç½®ï¼Œä½¿ç¼©æ”¾ä¸­å¿ƒä¸ºé¼ æ ‡ä½ç½®
        state.x = e.clientX - mouseX * state.scale;
        state.y = e.clientY - mouseY * state.scale;

        updateTransform();
    }, { passive: false });

    // é¼ æ ‡æŒ‰ä¸‹ï¼šå¼€å§‹æ‹–æ‹½
    els.viewport.addEventListener('mousedown', (e) => {
        if (state.width === 0) return;
        if (e.button === 0) { // å·¦é”®
            state.isDragging = true;
            state.dragStartX = e.clientX - state.x;
            state.dragStartY = e.clientY - state.y;
            els.viewport.classList.add('dragging');
        }
    });

    // é¼ æ ‡æ¾å¼€
    window.addEventListener('mouseup', () => {
        state.isDragging = false;
        els.viewport.classList.remove('dragging');
    });

    // é¼ æ ‡ç§»åŠ¨
    window.addEventListener('mousemove', (e) => {
        if (state.width === 0) return;

        if (state.isDragging) {
            // --- æ‹–æ‹½æ¨¡å¼ ---
            e.preventDefault();
            state.x = e.clientX - state.dragStartX;
            state.y = e.clientY - state.dragStartY;
            updateTransform();
        } else {
            // --- å¯¹æ¯”æ¨¡å¼ (ç§»åŠ¨åˆ†å‰²çº¿) ---
            // è·å–èˆå°åœ¨å±å¹•ä¸Šçš„å®é™…ä½ç½®çŸ©å½¢
            const rect = els.stage.getBoundingClientRect();
            
            // é¼ æ ‡åœ¨å›¾ç‰‡ä¸Šçš„ X åæ ‡ (ç›¸å¯¹äºå›¾ç‰‡å·¦è¾¹ç¼˜)
            let relativeX = e.clientX - rect.left;
            
            // è½¬æ¢ä¸ºç™¾åˆ†æ¯”
            let percent = (relativeX / rect.width) * 100;
            
            // é™åˆ¶ 0-100%
            percent = Math.max(0, Math.min(100, percent));

            els.layerOrig.style.width = percent + '%';
            els.handle.style.left = percent + '%';
        }
    });

    // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        // å¯é€‰ï¼šå¦‚æœå¸Œæœ›çª—å£å˜åŒ–æ—¶è‡ªåŠ¨å±…ä¸­ï¼Œå¯å–æ¶ˆä¸‹é¢æ³¨é‡Š
        // resetView();
    });

</script>
</body>
</html>